### 任务

编写一份使用transformer进行股票价格预测（多变量时间序列预测）的代码

技术要求使用pytorch

模型使用transformer

需要编写模型的构建，训练代码

编写之后，针对每部分代码给出具体的解释，并且检查可能存在的bug

### 模型需要：

* 一个编码器（encoder）
* 需要有位置编码（Positional encoding）
* 需要有正规化（normalization）
* 需要有mask来防止transformer看到future data

### 其他要求：

我已经建立好了数据集

```python
class StockDataset(Dataset):
    def __init__(self, dataframe, sequence_length):
        self.dataframe = dataframe
        self.sequence_length = sequence_length
        self.features = dataframe[feature_columns].values
        self.targets = dataframe[target_columns].values

    def __len__(self):
        return len(self.dataframe) - self.sequence_length

    def __getitem__(self, idx):
        return (
            torch.tensor(self.features[idx:idx + self.sequence_length], dtype=torch.float),
            torch.tensor(self.targets[idx + self.sequence_length], dtype=torch.float)  # Next day's close price
        )
```



输入的batch_size=64，预测的序列长度设定为120，输入的列长度为19，需要预测的列长度为7

```python
# 输入的列
feature_columns = ['o', 'h', 'l', 'c', 'v', 'qav', 'num_trades',
                   'EMA_7', 'EMA_25', 'EMA_99',
                   'MACD', 'Signal_Line', 'MACD_above_Signal', 'MACD_diff_Signal',
                   'RSI',
                   'Middle_Band', 'STD', 'Upper_Band', 'Lower_Band'
                   ]
# 需要预测的，输出的列
target_columns = ['o', 'h', 'l', 'c', 'v', 'qav', 'num_trades']
```

其中 'EMA_7', 'EMA_25', 'EMA_99','MACD', 'Signal_Line', 'MACD_above_Signal', 'MACD_diff_Signal','RSI','Middle_Band', 'STD', 'Upper_Band', 'Lower_Band'

这些列在训练过程中用于更好的捕获数据之间的pattern，但是他们本身不是需要输出的值，因为他们可以由价格等值计算得出





根据我提供的dataset的定义，我进行了实例化，如下所示

```
sequence_length = 60
train_dataset = StockDataset(train_df, sequence_length)
val_dataset = StockDataset(val_df, sequence_length)
test_dataset = StockDataset(test_df, sequence_length)

batch_size = 32
train_loader = DataLoader(train_dataset, batch_size=batch_size, shuffle=False)
val_loader = DataLoader(val_dataset, batch_size=batch_size, shuffle=False)
test_loader = DataLoader(test_dataset, batch_size=batch_size, shuffle=False)
```

但是我现在得到的train_loader的data与targets的形状为（batch_size, seq_len, feature_dim）与transformer要求的输入格式不符合，如何解决

```
class PositionalEncoding(nn.Module):

    def __init__(self, d_model, max_len=5000):
        super(PositionalEncoding, self).__init__()
        pe = torch.zeros(max_len, d_model)
        position = torch.arange(0, max_len, dtype=torch.float).unsqueeze(1)
        div_term = torch.exp(torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model))
        pe[:, 0::2] = torch.sin(position * div_term)
        pe[:, 1::2] = torch.cos(position * div_term)
        pe = pe.unsqueeze(0)
        pe = pe.transpose(0, 1)
        self.register_buffer('pe', pe)

    def forward(self, x):
        return x + self.pe[:x.size(0), :]


def generate_square_subsequent_mask(seq_len):
    """Generates a mask to prevent attention to future positions."""
    mask = torch.triu(torch.ones(seq_len, seq_len) * float('-inf'), diagonal=1)
    return mask


class StockPriceTransformer(nn.Module):
    def __init__(self, feature_size, d_model, num_layers, nhead=8, dropout=0.1,
                 max_len=5000):
        super(StockPriceTransformer, self).__init__()
        self.model_type = 'Transformer'
        self.src_mask = None
        self.pos_encoder = PositionalEncoding(d_model)
        self.encoder_layer = nn.TransformerEncoderLayer(d_model=d_model, nhead=nhead, dropout=dropout)
        self.transformer_encoder = nn.TransformerEncoder(self.encoder_layer, num_layers=num_layers)
        self.decoder = nn.Linear(d_model, feature_size)
        self.fc = nn.Linear(feature_size, d_model)
        self.init_weights()

    def init_weights(self):
        initrange = 0.1
        self.decoder.bias.data.zero_()
        self.decoder.weight.data.uniform_(-initrange, initrange)

    def forward(self, src, src_mask):
        src = self.fc(src)
        # src = self.encoder(src) * math.sqrt(self.feature_size)  # Adjust input dimensions
        src = self.pos_encoder(src)
        out = self.transformer_encoder(src, src_mask)
        out = self.decoder(out)
        return out
```
pip install torch torchvision torchaudio -f https://download.pytorch.org/whl/cu124/torch_stable.html
conda install pytorch torchvision torchaudio pytorch-cuda=12.4 -c pytorch -c nvidia

https://subb.xtt777.com/sub?target=clash&url=https%3A%2F%2Fapi.xtt777.com%2Fsubscribe%2F56602%2F8PzaFazWnVW%2Fssr%2F&insert=false&config=https%3A%2F%2Fraw.githubusercontent.com%2FACL4SSR%2FACL4SSR%2Fmaster%2FClash%2Fconfig%2FACL4SSR_Online.ini&emoji=true&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true